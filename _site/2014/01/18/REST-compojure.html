<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Oddball HTTP Requests in Compojure</title>
        <link rel="stylesheet" href="/css/syntax.css" >
        <link rel="stylesheet" href="/css/main.css" >
    </head>
    <body>


<main>
    <h1>Oddball HTTP Requests in Compojure</h1>

    <p>As a web-developer coding in Clojure, I want to use 
<a href="https://github.com/weavejester/compojure">Compojure</a> 
and Ring, specifically to handle various
RESTful situations. But how can I write a <code>PUT</code> Compojure route, and
jQuery AJAX request? It was trickier than it seems, and no one really
seems to discuss it.</p>

<p>There are three things to examine: the Compojure routes, the Ring
middleware, and the jQuery requests. Lets consider them in turn, then
put them all together for a minimal working (toy) example.</p>

<h2 id="toc_0">Compojure Methods</h2>

<p>Compojure routes are beautifully simple. Setting up <code>PUT</code> or <code>DELETE</code>
routes reduce to a triviality at this stage. So we may set up some toy
Compojure routes: </p>
<div class="highlight"><pre><code class="clojure language-clojure" data-lang="clojure"><span class="p">(</span><span class="kd">ns </span><span class="nv">rest-example.routes</span>
  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">compojure.core</span> <span class="ss">:refer</span> <span class="ss">:all</span><span class="p">]</span>
            <span class="p">[</span><span class="nv">compojure.route</span> <span class="ss">:as</span> <span class="nv">route</span><span class="p">]</span>
            <span class="p">[</span><span class="nv">rest-example.book</span> <span class="ss">:as</span> <span class="nv">book</span><span class="p">]))</span>

<span class="p">(</span><span class="nf">defroutes</span> <span class="nv">app</span>
  <span class="p">(</span><span class="nf">GET</span> <span class="s">&quot;/&quot;</span> <span class="p">[]</span> <span class="s">&quot;&lt;h1&gt;Hello World!&lt;/h1&gt;&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">PUT</span> <span class="s">&quot;/books/:id&quot;</span> <span class="nv">r</span> <span class="p">(</span><span class="nf">book/put-book</span> <span class="nv">r</span><span class="p">))</span>
  <span class="p">(</span><span class="nf">DELETE</span> <span class="s">&quot;/books/:id&quot;</span> <span class="nv">r</span> <span class="p">(</span><span class="nf">book/delete-book</span> <span class="nv">r</span><span class="p">))</span>
  <span class="p">(</span><span class="nf">GET</span> <span class="s">&quot;/books/:id&quot;</span> <span class="nv">r</span> <span class="p">(</span><span class="nf">book/get-book</span> <span class="nv">r</span><span class="p">)))</span>
</code></pre></div>
<h2 id="toc_1">Ring Difficulties</h2>

<p>The Ring middleware is actually (surprisingly) straightforward:</p>
<div class="highlight"><pre><code class="clojure language-clojure" data-lang="clojure"><span class="p">(</span><span class="kd">ns </span><span class="nv">rest-example.middleware</span>
  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">ring.middleware.params</span> <span class="ss">:refer</span> <span class="ss">:all</span><span class="p">]</span>
            <span class="p">[</span><span class="nv">ring.middleware.keyword-params</span> <span class="ss">:refer</span> <span class="ss">:all</span><span class="p">]))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">my-middleware</span> <span class="p">[</span><span class="nv">routes</span><span class="p">]</span>
  <span class="p">(</span><span class="nb">-&gt; </span><span class="nv">routes</span>
      <span class="nv">wrap-keyword-params</span>
      <span class="nv">wrap-params</span><span class="p">))</span> <span class="c1">;; whatever else you do should be appended</span>
</code></pre></div>
<h2 id="toc_2">jQuery Requests</h2>

<p>So, the jQuery request for a <code>PUT</code>, <code>PATCH</code>, or <code>DELETE</code> should look
like:</p>
<div class="highlight"><pre><code class="javascript language-javascript" data-lang="javascript"><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span><span class="nx">url</span><span class="o">:</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">,</span> <span class="cm">/* ... */</span><span class="p">});</span>
</code></pre></div>
<p>But if you don&#39;t want to repeat yourself over and over and over, you can
add a few lines of Javascript extending jQuery (c.f., lines 8273 of
<code>jquery-1.10.2.js</code> for example):</p>
<div class="highlight"><pre><code class="javascript language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">_ajax_request</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">method</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// shift arguments if data argument was omitted</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span> <span class="nx">data</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">type</span> <span class="o">=</span> <span class="nx">type</span> <span class="o">||</span> <span class="nx">callback</span><span class="p">;</span>
        <span class="nx">callback</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
        <span class="nx">data</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
        <span class="nx">url</span><span class="o">:</span> <span class="nx">url</span><span class="p">,</span>
        <span class="nx">type</span><span class="o">:</span> <span class="nx">method</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">(),</span>
        <span class="nx">dataType</span><span class="o">:</span> <span class="nx">type</span><span class="p">,</span>
        <span class="nx">data</span><span class="o">:</span> <span class="nx">data</span><span class="p">,</span>
        <span class="nx">success</span><span class="o">:</span> <span class="nx">callback</span>
    <span class="p">});</span>
<span class="p">};</span>
<span class="nx">jQuery</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">put</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">_ajax_request</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="s2">&quot;put&quot;</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">patch</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">_ajax_request</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="s2">&quot;patch&quot;</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="k">delete</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">_ajax_request</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="s2">&quot;delete&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre></div>
<p>This will allow you to write lines of code like <code>$.delete(url)</code>, and so
on. So there will be no need to repeat yourself</p>

<h3 id="toc_3">Puzzle</h3>

<p>The non-standard requests (e.g., <code>PUT</code>, <code>PATCH</code>, <code>DELETE</code>, and friends)
are trickier to handle since browsers do not universally support
them. </p>

<p>What <a href="https://github.com/weavejester/compojure/blob/master/src/compojure/core.clj#L19">Compojure does</a>
is quite simple: simply do a <code>POST</code> request, with the <code>:form-params</code>
have a field <code>&quot;_method&quot;</code> which is <code>&quot;patch&quot;</code>, <code>&quot;put&quot;</code>, or <code>&quot;delete&quot;</code> (or
whatever request you want).</p>

<p>Compojure routes check the <code>form-params</code>, which in turn checks the
<code>_method</code> in the HTTP request body. Is there some way to add in
<code>_method: DELETE</code> (or <code>PUT</code> or...) directly in jQuery?</p>

<p><em>Remark.</em> This would actually cause problems with Internet Explorer
 browsers if we don&#39;t solve this puzzle. (End of Remark)</p>

<h2 id="toc_4">Combining Everything Together</h2>

<p>So, now we have our <code>core.clj</code> which looks like:</p>
<div class="highlight"><pre><code class="clojure language-clojure" data-lang="clojure"><span class="p">(</span><span class="kd">ns </span><span class="nv">rest-example.core</span>
  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">ring.adapter.jetty</span> <span class="ss">:refer</span> <span class="ss">:all</span><span class="p">]</span>
            <span class="p">[</span><span class="nv">rest-example.routes</span> <span class="ss">:as</span> <span class="nv">routes</span><span class="p">]</span>
            <span class="p">[</span><span class="nv">rest-example.middleware</span> <span class="ss">:as</span> <span class="nv">middleware</span><span class="p">]))</span>

<span class="p">(</span><span class="k">def </span><span class="nv">routes</span> <span class="p">(</span><span class="nf">middleware/my-middleware</span> <span class="nv">routes/app</span><span class="p">))</span>

<span class="p">(</span><span class="kd">defn </span><span class="nv">-main</span> <span class="p">[]</span>
  <span class="p">(</span><span class="nf">run-jetty</span> <span class="o">#</span><span class="ss">&#39;rest-example/routes</span> <span class="p">{</span><span class="ss">:port</span> <span class="mi">8080</span><span class="p">}))</span>
</code></pre></div>
<p>The complete working code (which really works!) is
<a href="https://github.com/pqnelson/rest-example">available</a>. </p>

</main>

<footer>

<blockquote>
"To obey a rule, to make a report, to give an order, to play a game of chess, are <em>customs</em>."


<br />
&mdash; Ludwig Wittgenstein, <em>Philosophical Investigations</em> &sect;199

</blockquote>



<a href="/">Home</a> &mdash;

<span class="copyright">
<a rel="license"
   href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.en_US">(C)</a>
   2013, 2014.
</span>
</footer>
</body>
</html>

